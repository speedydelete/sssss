<!DOCTYPE html>
<html>
    <head>
        <title>5S</title>
        <meta charset="utf-8">
        <style>

* {
    box-sizing: border-box;
}

html, body {
    position: absolute;
    inset: 0;
    height: 100%;
    width: 100%;
    font-family: Arial, Helvetica, sans-serif;
}

body {
    padding: 20px;
    margin: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
}

h1, h2 {
    text-align: center;
}

button, input:not([type=checkbox]) {
    padding: 3px 6px;
    font-size: inherit;
    background-color: inherit;
    color: inherit;
    border: 1px solid black;
}

button {
    font-family: inherit;
}

input {
    font-family: 'Courier New', Courier, monospace;
}

input:focus {
    outline: none;
}

input[type=number] {
    appearance: textfield;
}

textarea {
    resize: none;
    font-family: 'Courier New', Courier, monospace;
    font-size: 1em;
    overflow-wrap: anywhere;
    overflow-y: auto;
}

textarea:focus {
    outline: none;
}

select {
    padding: 5px;
    appearance: none;
    background-color: #ffffff;
    background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' version='1.1' viewBox='0 0 16 16'><line x1='1' y1='6' x2='6' y2='12' stroke='%23000000' stroke-width='0.85' /><line x1='11' y1='6' x2='6' y2='12' stroke='%23000000' stroke-width='0.85' /></svg>");
    background-repeat: no-repeat;
    background-position: right;
    background-size: 16px;
    color: #000000;
    border: 1px solid #000000;
}

select:focus {
    outline: none;
}

option {
    background-color: #ffffff;
}

#main {
    min-height: 0;
    flex: 1 1 auto;
    width: 100%;
    display: flex;
    flex-flow: row wrap;
    gap: 20px;
}

#main > div {
    min-height: 0;
    max-height: 100%;
    width: calc(50% - 10px);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
}

#top {
    display: flex;
    flex-direction: row;
    gap: 3ch;
    justify-content: center;
    align-items: center;
}

#type {
    box-sizing: content-box;
    width: calc(16ch + 21px);
}

#speed-wrapper {
    display: flex;
    flex-direction: column;
    align-items: start;
    gap: 20px;
}

#speed {
    width: 24ch;
}

#out {
    flex: 1 1 auto;
    min-height: 0;
    max-width: 72ch;
    white-space: pre-wrap;
    overflow-wrap: anywhere;
    overflow-y: auto;
    font-family: 'Courier New', Courier, monospace;
}

#ships, #ships-out {
    width: 80%;
    height: 10ch;
    flex: 1 0 auto;
}

#ships-out {
    display: none;
    white-space: pre-wrap;
    min-height: 0;
    overflow-wrap: anywhere;
    overflow-y: auto;
    font-family: 'Courier New', Courier, monospace;
    white-space: pre-wrap;
}

        </style>
    </head>
    <body spellcheck="false" autocapitalize="" autocorrect="off" writingsuggestions="false">
        <div>
            <h1>Smallest Spaceships Supporting Specific Speeds (5S)</h1>
            <div id="top">
                <div>
                    Rulespace:
                    <select id="type">
                        <option value="int">INT</option>
                        <option value="intb0">INT B0</option>
                        <option value="ot">OT</option>
                        <option value="otb0">OT B0</option>
                        <option value="intgen">INT Generations</option>
                        <option value="intgenb0">INT Generations B0</option>
                        <option value="otgen">OT Generations</option>
                        <option value="otgenb0">OT Generations B0</option>
                    </select>
                </div>
                <a href="https://conwaylife.com/forums/viewtopic.php?f=11&t=2892">More information</a>
                <a href="https://github.com/speedydelete/sssss">Source code</a>
            </div>
        </div>
        <div id="main">
            <div>
                <h2>Search Speed</h2>
                <div id="speed-wrapper">
                    <div>Speed: <input type="text" id="speed" /></div>
                    <button id="search">Search</button>
                </div>
                <div id="out"></div>
            </div>
            <div>
                <h2>Submit Spaceships</h2>
                Enter spaceships in RLE or CSV format. The maximum period is 32768. If you would like to submit higher-period ship, or an adjustable ship (don't submit adjustable ships here!) please contact speedydelete on the ConwayLife.com forums or Discord.
                <textarea id="ships"></textarea>
                <div id="ships-out"></div>
                <button id="submit">Submit</button>
            </div>
        </div>
        <script>'use strict';function printError(e,c='red'){let x=String(e instanceof Error?('stack' in e?e.stack:e):e);if(!x.includes('Error')){x=String(e)+'\n'+x}x=x.replaceAll('@',' at ');if(!(document.readyState==='complete')){alert(x);return;}document.querySelectorAll('body > *').forEach(x=>x.remove());let t=document.createElement('pre');t.style.color=c;t.style.marginTop='100px';t.style.fontFamily='\'Courier New\',Courier,monospace';t.style.fontSize='14px';t.style.overflowWrap='break-word';t.textContent=x.replaceAll(/file:\/\/\/media\/fuse\/drivefs-[0-9a-f]+\/root\/code\//g,'');document.body.appendChild(t);let l=setInterval(()=>{},0);for(let j=1;j<=l;j++){clearInterval(j);}window.onkeydown=()=>{};}window.addEventListener('error',e=>{printError(e.error);return true;});window.addEventListener('unhandledrejection',e=>{e.preventDefault();printError(e.reason);});</script>
        <script type="module">

import {TRANSITIONS, VALID_TRANSITIONS, unparseTransitions, arrayToTransitions, MAPB0Pattern, MAPB0GenPattern, findType, findMinmax, parse, parseSpeed, speedToString} from '../lifeweb/index.js';


function parseData(data) {
    let out = [];
    if (data.match((/x\s*=\s*\d+\s*,?\s*y\s*=\s*\d+\s*,?\s*(?:rule\s*=\s*(.*))/))) {
        let currentRLE = '';
        let rleNumber = 0;
        let isFirstLine = false;
        for (let line of data.split('\n')) {
            line = line.trim();
            if (line === '' || line.startsWith('#')) {
                continue;
            }
            if (line.startsWith('x')) {
                if (currentRLE !== '') {
                    let p = parse(currentRLE);
                    let type = findType(p, 32768, false);
                    if (!type.disp || (type.disp[0] === 0 && type.disp[1] === 1)) {
                        alert(`Pattern #${rleNumber} is not a spaceship or its period is higher than 32768!`);
                    } else {
                        out.push({
                            pop: 0,
                            rule: p.ruleStr,
                            dx: type.disp[0],
                            dy: type.disp[1],
                            period: type.period,
                            rle: p.toRLE().split('\n').slice(1).join(''),
                        });
                    }
                }
                currentRLE = line + '\n';
                rleNumber++;
            } else if (isFirstLine) {
                alert('First line must be a RLE header');
            } else {
                currentRLE += line + '\n';
            }
        }
        if (currentRLE !== '') {
            let p = parse(currentRLE);
            let type = findType(p, 32768, false);
            if (!type.disp || (type.disp[0] === 0 && type.disp[1] === 1)) {
                alert(`Pattern #${rleNumber} is not a spaceship or its period is higher than 32768!`);
            } else {
                out.push({
                    pop: 0,
                    rule: p.ruleStr,
                    dx: type.disp[0],
                    dy: type.disp[1],
                    period: type.period,
                    rle: p.toRLE().split('\n').slice(1).join(''),
                });
            }
        }
    } else {
        for (let line of data.split('\n')) {
            line = line.trim();
            if (line === '' || line.startsWith('#')) {
                continue;
            }
            let info = line.split(', ');
            out.push({
                pop: parseInt(info[0]),
                rule: info[1],
                dx: parseInt(info[2]),
                dy: parseInt(info[3]),
                period: parseInt(info[4]),
                rle: info[5],
            });
        }
    }
    return out;
}

function shipsToString(ships) {
    let out = '';
    for (let ship of ships) {
        out += ship.pop + ', ' + ship.rule + ', ' + ship.dx + ', ' + ship.dy + ', ' + ship.period + ', ' + ship.rle + '\n';
    }
    return out;
}


function removeDuplicateShips(ships) {
    ships = sortShips(ships);
    let out = [];
    let prev = ships[0];
    for (let ship of ships.slice(1)) {
        if (prev.dx === ship.dx && prev.dy === ship.dy && prev.period === ship.period) {
            if (prev.pop < ship.pop) {
                continue;
            } else if (prev.pop > ship.pop) {
                out.pop();
            }
        }
        out.push(ship);
        prev = ship;
    }
    return out;
}

function normalizeShips(type, ships, throwInvalid, globalLimit) {
    let isOT = type.startsWith('ot');
    let out = [];
    let invalidShips = [];
    for (let i = 0; i < ships.length; i++) {
        let ship = ships[i];
        let p = parse(`x = 0, y = 0, rule = ${ship.rule}\n${ship.rle}`);
        let limit = Math.ceil(ship.period / p.rulePeriod) * p.rulePeriod + 1;
        if (globalLimit !== undefined) {
            limit = Math.min(limit, globalLimit);
        }
        let type = findType(p, limit, false);
        if (!type.disp || (type.disp[0] === 0 && type.disp[1] === 0)) {
            if (throwInvalid) {
                throw new Error(`Invalid ship detected: ${shipsToString([ship]).slice(0, -1)}`);
            } else {
                console.log(`Invalid ship detected: ${shipsToString([ship]).slice(0, -1)}`);
                invalidShips.push(speedToString(ship));
                continue;
            }
        }
        if (ship.dx !== type.disp[0] || ship.dy !== type.disp[1] || ship.period !== type.period) {
            console.log(`Warning: Replacing ${speedToString(ship)} with ${speedToString({dx: type.disp[0], dy: type.disp[1], period: type.period})}`);
        }
        ship.dx = type.disp[0];
        ship.dy = type.disp[1];
        if (ship.dx === 0 && ship.dy !== 0) {
            p.rotateRight();
            ship.dx = -ship.dy;
            ship.dy = 0;
            type = findType(p, limit, false);
            if (type.period !== ship.period || !type.disp || ship.dx !== type.disp[0] || ship.dy !== type.disp[1]) {
                if (throwInvalid) {
                    throw new Error(`Invalid ship detected: ${shipsToString([ship]).slice(0, -1)}`);
                } else {
                    console.log(`Invalid ship detected: ${shipsToString([ship]).slice(0, -1)}`);
                    invalidShips.push(speedToString(ship));
                    continue;
                }
            }
        }
        if (ship.dx < 0 || ship.dy < 0 || Math.abs(ship.dx) < Math.abs(ship.dy)) {
            if (ship.dx < 0) {
                p.flipHorizontal();
                ship.dx = -ship.dx;
            }
            if (ship.dy < 0) {
                p.flipVertical();
                ship.dy = -ship.dy;
            }
            if (ship.dx < ship.dy) {
                let temp = ship.dx;
                ship.dx = ship.dy;
                ship.dy = temp;
                p.rotateLeft().flipVertical();
            }
            type = findType(p, limit, false);
            if (type.period !== ship.period || !type.disp || ship.dx !== type.disp[0] || ship.dy !== type.disp[1]) {
                if (throwInvalid) {
                    throw new Error(`Invalid ship detected: ${shipsToString([ship]).slice(0, -1)}`);
                } else {
                    console.log(`Invalid ship detected: ${shipsToString([ship]).slice(0, -1)}`);
                    invalidShips.push(speedToString(ship));
                    continue;
                }
            }
        }
        ship.rule = findMinmax(p, limit, undefined, undefined, isOT)[0];
        if (p instanceof MAPB0Pattern || p instanceof MAPB0GenPattern) {
            let minPop = type.phases[0].population;
            let minPhase = type.phases[0];
            let evenRule = ship.rule;
            let [bTrs, sTrs] = arrayToTransitions(p.evenTrs.reverse(), TRANSITIONS);
            let bStr = unparseTransitions(bTrs, VALID_TRANSITIONS, false);
            let sStr = unparseTransitions(sTrs, VALID_TRANSITIONS, false);
            let oddRule;
            if (p instanceof MAPB0Pattern) {
                oddRule = `B${bStr}/S${sStr}`;
            } else {
                oddRule = `${sStr}/${bStr}/${p.states}`;
            }
            for (let i = 0; i < type.phases.length; i++) {
                let phase = type.phases[i];
                if (phase.population < minPop) {
                    minPop = phase.population;
                    minPhase = phase;
                    ship.rule = i % 2 === 0 ? evenRule : oddRule;
                }
            }
            ship.pop = minPop;
            ship.rle = minPhase.toRLE().split('\n').slice(1).join('');
            if (ship.rule === oddRule) {
                p = parse(`x = 0, y = 0, rule = ${ship.rule}\n${ship.rle}`);
                ship.rule = findMinmax(p, limit, undefined, undefined, isOT)[0];
            }
        } else {
            let minPop = type.phases[0].population;
            let minPhase = type.phases[0];
            for (let i = 0; i < type.phases.length; i++) {
                let phase = type.phases[i];
                if (phase.population < minPop) {
                    minPop = phase.population;
                    minPhase = phase;
                }
            }
            ship.pop = minPop;
            ship.rle = minPhase.toRLE().split('\n').slice(1).join('');
        }
        out.push(ship);
        if (i % 20 === 0 && i > 0) {
            console.log(`${i}/${ships.length} ships normalized`);
        }
    }
    out = removeDuplicateShips(out);
    return throwInvalid === false ? [out, invalidShips] : out;
}


function validateType(type, ship) {
    let correct = false;
    let p = createPattern(ship.rule);
    if (type === 'int') {
        if (p instanceof MAPPattern && p.ruleSymmetry === 'D8') {
            correct = true;
        }
    } else if (type === 'intb0') {
        if (p instanceof MAPB0Pattern && p.ruleSymmetry === 'D8') {
            correct = true;
        }
    } else {
        alert(`Invalid ship type: '${type}'`);
    }
    if (!correct) {
        alert(`Invalid rule for ${type}: ${ship.rule}`);
    }
    return correct;
}


let typeSelect = document.getElementById('type');
let speedInput = document.getElementById('speed');
let searchButton = document.getElementById('search');
let searchOutput = document.getElementById('out');
let shipsInput = document.getElementById('ships');
let shipsOutput = document.getElementById('ships-out');
let submitButton = document.getElementById('submit');

searchButton.addEventListener('click', async () => {
    let data = parseSpeed(speedInput.value);
    if (!data) {
        return;
    }
    let {dx, dy, period} = data;
    let resp = await fetch(`./api/get?type=${typeSelect.value}&dx=${dx}&dy=${dy}&period=${period}`);
    if (resp.ok) {
        searchOutput.textContent = await resp.text();
    } else {
        if (resp.status === 429) {
            alert('You are being rate limited! Try again in 5 seconds!');
        } else {
            alert(`Error: Server returned ${resp.status} ${resp.statusText}!`);
        }
    }
});

let isBackButton = false;

submitButton.addEventListener('click', async () => {
    if (isBackButton) {
        shipsInput.style.display = 'block';
        shipsOutput.style.display = 'none';
        submitButton.textContent = 'Submit';
        isBackButton = false;
        return;
    }
    let rawShips = parseData(document.getElementById('ships').value);
    let [ships, invalidShips] = normalizeShips(typeSelect.value, rawShips, false, 32768);
    if (ships.length === 0) {
        alert(`No ships provided or all ships are invalid!`);
        return;
    }
    for (let ship of ships) {
        if (!validateType(typeSelect.value, ship)) {
            return;
        }
    }
    shipsInput.style.display = 'none';
    shipsOutput.style.display = 'block';
    shipsOutput.textContent = 'Adding ships...';
    submitButton.textContent = 'Back';
    isBackButton = true;
    let resp = await fetch(`./api/add?type=${typeSelect.value}`, {
        method: 'POST',
        body: shipsToString(ships),
    });
    if (resp.ok) {
        shipsInput.style.display = 'none';
        shipsOutput.style.display = 'block';
        submitButton.textContent = 'Back';
        let out = await resp.text();
        if (invalidShips.length > 0) {
            out = `${invalidShips.length} invalid ships removed before submitting: ${invalidShips.join(', ')}\n${out}`;
        }
        shipsOutput.textContent = out;
        isBackButton = true;
    } else {
        if (resp.status === 429) {
            shipsInput.style.display = 'block';
            shipsOutput.style.display = 'none';
            submitButton.textContent = 'Submit';
            isBackButton = false;
            alert('You are being rate limited! Try again in 5 seconds!');
        } else {
            shipsOutput.textContent = `Error: Server returned ${resp.status} ${resp.statusText}!`;
        }
    }
});


for (let type of ['input', 'textarea', 'select']) {
    document.querySelectorAll(type).forEach(elt => {
        let key = '5s-' + type + '-' + elt.id;
        let value = localStorage[key];
        if (value) {
            elt.value = value;
        }
        elt.addEventListener('change', () => {
            localStorage[key] = elt.value;
        });
    });
}

        </script>
    </body>
</html>

